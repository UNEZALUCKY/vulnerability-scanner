import os
import sys
import json
from django.http import JsonResponse
from django.shortcuts import render
from django.urls import path
from django.conf import settings
from django.core.management import execute_from_command_line
from django.http import HttpResponse
from django.views.decorators.csrf import csrf_exempt

# Configure Django settings
settings.configure(
    DEBUG=True,
    SECRET_KEY='your-secret-key',  # Change this in a production app
    ROOT_URLCONF=__name__,
    INSTALLED_APPS=[
        'django.contrib.contenttypes',
        'django.contrib.sessions',
        'django.contrib.messages',
        'django.contrib.staticfiles',
    ],
)

# Define the view for scanning URLs
@csrf_exempt  # Disable CSRF for simplicity
def scan(request):
    if request.method == 'POST':
        data = json.loads(request.body)
        url = data.get('url')

        if not url:
            return JsonResponse({'error': 'No URL provided'}, status=400)

        # Mock scan results
        mock_results = {
            'url': url,
            'vulnerabilities': [
                {'name': 'SQL Injection', 'severity': 'High'},
                {'name': 'Cross-Site Scripting', 'severity': 'Medium'}
            ]
        }

        return JsonResponse(mock_results)
    else:
        return JsonResponse({'error': 'Invalid request method'}, status=405)

# Define the URL routes
urlpatterns = [
    path('scan/', scan),
]

# The main function to run the app
def main():
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', '__name__')
    try:
        execute_from_command_line(sys.argv)
    except Exception as e:
        print(f"Error: {e}")

# To run the server
if __name__ == "__main__":
    main()
